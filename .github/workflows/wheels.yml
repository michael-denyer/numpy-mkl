name: Wheels

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
        description: "Package to build (numpy, scipy)"
      repo:
        required: true
        type: string
        description: "Repo to build (numpy, scipy)"
      force-build:
        required: false
        type: boolean
        description: "Force build even if wheels exist"
      manylinux:
        required: false
        type: boolean
        description: "Build Linux wheels in manylinux container"
      version:
        required: false
        type: string
        description: "Version to build (default: latest release)"

jobs:
  meta:
    if: github.repository == 'michael-denyer/numpy-mkl'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ env.tag }}
      version: ${{ env.version }}
      matrix: ${{ env.matrix }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up python
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          version-file: "pyproject.toml"

      - name: Fetch build matrix
        run: |
          uv run tools/fetch_matrix2 ${{ inputs.name }} --config ci-targets.yaml \
            --store build.json --token ${{ secrets.GITHUB_TOKEN }} \
            ${{ inputs.force-build && '--force-build' || '' }} >matrix.json

          echo "tag=$(jq -rc '."tag"' matrix.json)" >>$GITHUB_ENV
          echo "version=$(jq -rc '."version"' matrix.json)" >>$GITHUB_ENV
          echo "matrix=$(jq -c '."matrix"' matrix.json)" >>$GITHUB_ENV

          cat matrix.json | yq -P -o yaml

  #-----------------------------------------------------------------------------------------------
  build:
    name: ${{ inputs.name }}-${{ matrix.python_version }} (${{ matrix.runner }})
    needs: meta
    if: ${{ needs.meta.outputs.matrix != 'null' }}
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    strategy:
      matrix: ${{ fromJson(needs.meta.outputs.matrix) }}
      fail-fast: false
    # Don't use continue-on-error: broken wheels would get released.
    defaults:
      run:
        shell: bash

    steps:
      - name: Check out repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Check out src
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.repo }}
          ref: ${{ needs.meta.outputs.tag }}
          path: src
          submodules: recursive
          persist-credentials: false

      - name: Prepare environment
        run: |
          # Need this since pyproject.toml doesn't apply to $SRC_DIR.
          echo "UV_PYTHON_PREFERENCE=only-managed" >>$GITHUB_ENV

          echo "venv_bin=bin" >>$GITHUB_ENV

          # Move src to avoid pyproject conflicts.
          mv src ../../ && echo "SRC_DIR=${GITHUB_WORKSPACE}/../../src" >>$GITHUB_ENV

          # Keep MKL directory short as it ends up in the final build.
          echo "MKL_DIR=$(realpath "${GITHUB_WORKSPACE}"/../../mkl)" >>$GITHUB_ENV

      - name: Set up python
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          python-version: ${{ matrix.python_version }}
          version-file: "pyproject.toml"
          enable-cache: false

      - name: Install MKL libraries
        run: |
          uv venv "${{ env.MKL_DIR }}"
          source "${{ env.MKL_DIR }}/${{ env.venv_bin }}"/activate
          uv pip install mkl-devel

          # Get MKL version.
          echo "MKL_VERSION=$(uv pip show mkl | grep '^Version' | sed 's/Version: //')" \
              >>$GITHUB_ENV

          # Get pkg-config path.
          echo "PKG_CONFIG_PATH=$(python tools/get_file_in_pkg mkl-sdl.pc \
              --pkg mkl-devel --parent)" >>$GITHUB_ENV

          # Fetch MKL license.
          cat "$(python tools/get_file_in_pkg LICENSE.txt --pkg mkl-devel)" \
              >>"${GITHUB_WORKSPACE}/patches/LICENSE_MKL.txt"

          # Add .so -> .so.2 symlinks to fix linking for mkl-service.
          cd "${{ env.MKL_DIR }}"/lib
          for i in $( ls libmkl*.so.2 ); do ln -s $i ${i%.*}; done

      - name: Apply patches
        run: |
          # Apply patches.
          cd "${{ env.SRC_DIR }}"
          git apply "${GITHUB_WORKSPACE}"/patches/${{ inputs.name }}/*.patch


      - name: Add MKL to runtime dependencies
        working-directory: ${{ env.SRC_DIR }}
        run: |
          # Pin runtime library to the exact version used for compiling.
          if [[ "${{ inputs.name }}" == "mkl-service" ]]; then
            # MKLROOT must be set, even with --no-sync.
            MKLROOT="${{ env.MKL_DIR }}" uv add --no-sync mkl>="${{ env.MKL_VERSION }}"
          else
            uv add --no-sync mkl>="${{ env.MKL_VERSION }}" mkl-service
          fi

      - name: Add MKL licence
        working-directory: ${{ env.SRC_DIR }}
        run: |
          echo "" >>LICENSE.txt
          echo "----" >>LICENSE.txt
          echo "" >>LICENSE.txt
          [[ "${{ inputs.name }}" == "scipy" ]] && cat LICENSES_bundled.txt >>LICENSE.txt
          cat "${GITHUB_WORKSPACE}/patches/LICENSE_MKL.txt" >>LICENSE.txt
        if: inputs.name != 'mkl-service'

      - name: Install manylinux build dependencies
        run: |
          case "${{ inputs.name }}" in
            mkl-service)
              dnf -y install clang
              ;&
            numpy)
              # Tests for distutil require clang (Python < 3.12).
              [[ "$UV_PYTHON" =~ ^(cp310|cp311)$ ]] && dnf -y install clang || true
              ;&
            # scipy)
            #   # Test dependency gmpy2 hasn't released pre-build wheels for py314, building
            #   # from scratch requires libmpc-devel.
            #   [[ "$UV_PYTHON" =~ ^(cp314)$ ]] && dnf -y install libmpc-devel || true
            #   ;&
          esac
        if: inputs.manylinux

      - name: Build wheel
        working-directory: ${{ env.SRC_DIR }}
        run: |
          case "${{ inputs.name }}" in
            numpy)
              # ILP64: Use 64-bit integer interface to support matrices >46k x 46k
              # mkl-dynamic-ilp64-seq uses sequential threading (simpler, avoids thread bugs)
              # -Dblas-symbol-suffix=_64 forces _64-suffixed symbols (dsyevd_64_ not dsyevd_)
              # so the linker can ONLY resolve to ILP64 libraries. Without this, auditwheel-
              # bundled wheels may resolve unsuffixed symbols to LP64 and return garbage.
              # This matches scipy's approach (scipy/meson.build:386-390).
              args="-Csetup-args=-Dblas=mkl-dynamic-ilp64-seq \
                    -Csetup-args=-Dlapack=mkl-dynamic-ilp64-seq \
                    -Csetup-args=-Duse-ilp64=true \
                    -Csetup-args=-Dblas-symbol-suffix=_64 \
                    -Csetup-args=-Dallow-noblas=false \
                    -Csetup-args=-Dcpu-baseline=F16C \
                    -Csetup-args=-Dcpu-dispatch=AVX512_ICL"
              ;;

            scipy)
              # ILP64: Use 64-bit integer interface for scipy as well
              # MSVC is unable to compile Pythran, use gcc or set -Duse-pythran=false.
              args="-Csetup-args=-Dblas=mkl-dynamic-ilp64-seq \
                    -Csetup-args=-Dlapack=mkl-dynamic-ilp64-seq \
                    -Csetup-args=-Duse-ilp64=true \
                    -Csetup-args=-Dblas-symbol-suffix=_64 \
                    -Csetup-args=-Duse-g77-abi=true"
              ;;

            'mkl-service')
              export MKLROOT="${{ env.MKL_DIR }}"
              export CFLAGS="${CFLAGS} -fno-fast-math"
              args="--no-build-isolation"
              uv venv buildenv && source buildenv/"${{ env.venv_bin }}"/activate
              uv pip install setuptools cython
              ;;
          esac
          uv build --wheel --index https://michael-denyer.github.io/numpy-mkl ${args}

      - name: Repair wheel (Linux)
        run: |
          mkdir -p wheelhouse
          plat="$(ldd --version | head -1 | awk '{ print $NF }' | tr '.' '_')_$(uname -m)"
          # ILP64: Bundle MKL libs into wheel since PyPI mkl only has LP64
          # This makes larger wheels but avoids runtime dependency issues
          uvx auditwheel repair "${{ env.SRC_DIR }}"/dist/*.whl -w wheelhouse \
              --plat=manylinux_${plat}
        if: runner.os == 'linux'

      - name: Run tests
        run: |
          # Set up test environment.
          uv venv testenv && source testenv/"${{ env.venv_bin }}"/activate
          # Install wheel with --no-deps to prevent PyPI pulling LP64 mkl/mkl-service
          # into the ILP64 test environment.
          uv pip install --no-deps wheelhouse/*.whl

          # MKL runtime libs: auditwheel bundles directly-linked libs (.so NEEDED entries)
          # into numpy.libs/, but MKL's dispatcher loads computational kernels like
          # libmkl_def.so.2 via dlopen() at runtime. These aren't in NEEDED entries so
          # auditwheel doesn't bundle them. Point LD_LIBRARY_PATH at the MKL install so
          # the dispatcher can find them. (End users get this via mkl-service.)
          export LD_LIBRARY_PATH="${{ env.MKL_DIR }}/lib:${LD_LIBRARY_PATH:-}"

          case "${{ inputs.name }}" in
            numpy)
              uv pip install -r "${{ env.SRC_DIR }}"/requirements/test_requirements.txt
              uv pip install threadpoolctl
              python tools/numpy_tests.py
              ;;

            scipy)
              # Only install essential test dependencies, mirroring official wheel builder.
              uv pip install pytest pytest-xdist threadpoolctl pooch hypothesis
              python tools/scipy_tests.py
              ;;

            mkl-service)
              uv pip install pytest
              pytest -s -v --pyargs mkl
              ;;
          esac

      - name: Store build information
        run: |
          cat >wheelhouse/versions-${{ matrix.python_version}}-${{ runner.os }}.json <<EOF
          {
            "name": "${{ inputs.name }}",
            "version": "${{ needs.meta.outputs.version }}",
            "python": "${{ matrix.python_version }}",
            "os": "${{ runner.os }}",
            "mkl": "${{ env.MKL_VERSION }}"
          }
          EOF

      - name: Archive
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ inputs.name }}-${{ matrix.python_version }}-${{ runner.os }}
          path: |
            wheelhouse/*.whl
            wheelhouse/*.json
          retention-days: 1

  #-----------------------------------------------------------------------------------------------
  release:
    needs: [meta, build]
    if: ${{ needs.meta.outputs.matrix != 'null' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # Explicitly set ref to include commits from the meta job.
          # https://github.com/actions/checkout/issues/439#issuecomment-830862188
          ref: main
          persist-credentials: true  # Need credentials to push.

      - name: Checkout deployment branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: pypi
          path: pypi
          persist-credentials: true  # Need credentials to push.

      - name: Set up python
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          version-file: "pyproject.toml"

      - name: Fetch wheels
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: ${{ inputs.name }}-*
          path: release
          merge-multiple: true

      - name: Bump project version
        run: |
          uv version --bump patch
          echo "VERSION=$(uv version --short)" >>$GITHUB_ENV

      - name: Store build metadata
        run: |
          tools/store_info.py release/*.json --store build.json

      - name: Update badges
        run: |
          tools/update_icons README.md --store build.json

      - name: Commit release data
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
              echo "No changes to commit"
              exit 0
          fi
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add .
          git commit -m "ci: Prepare release for ${{ inputs.name }}-${{ needs.meta.outputs.version }}"
          git push origin HEAD:main

      - name: Write release notes
        run: |
          uv run tools/release_notes templates/release.md --store build.json >release/release.md

      - name: Release wheels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${VERSION}" --title "${VERSION}" --notes-file release/release.md release/*.whl

      - name: Generate index
        run: |
          # Wait 10s for release to get finished.
          sleep 10
          uv run tools/make_index2 pypi/${{ inputs.name}}/index.html --token ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy index
        working-directory: pypi
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
              echo "No changes to commit"
              exit 0
          fi
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add .
          git commit -m "ci: Add wheels for ${{ inputs.name }}-${{ needs.meta.outputs.version }}"
          git push origin HEAD:pypi

...
# vim: set tw=98:
